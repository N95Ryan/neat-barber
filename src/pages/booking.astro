---
import Layout from "../layouts/Layout.astro";
import Navbar from "../components/Navbar.astro";

const planityKey = import.meta.env.PUBLIC_PLANITY_KEY;

// Planity public key check
if (!planityKey) {
  console.warn(
    "⚠️ PUBLIC_PLANITY_KEY is not defined in the public environment variables"
  );
}
---

<Layout title="Réservation - Neat Barber Paris">
  <header class="main-header">
    <Navbar />
  </header>

  <!-- Booking section with background and Planity widget -->
  <section class="booking-section relative">
    <!-- Background with overlay -->
    <div
      class="absolute inset-0 bg-hero-pattern bg-cover bg-center bg-no-repeat"
    >
      <div
        class="absolute inset-0 bg-gradient-to-r from-black/80 via-black/60 to-transparent"
      >
      </div>
    </div>

    <!-- Planity widget container -->
    <div class="container relative z-10">
      <div class="row justify-content-center">
        <div class="col-lg-10 col-md-12">
          <div class="planity-wrapper">
            <div id="planity-container" style="min-height: 800px;"></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Planity scripts injected after DOM content is loaded -->
  <script define:vars={{ planityKey: planityKey }}>
    document.addEventListener("DOMContentLoaded", function () {
      const container = document.getElementById("planity-container");

      if (!container) {
        console.error("Planity container not found");
        return;
      }

      // Planity key validation
      if (
        !planityKey ||
        planityKey === "undefined" ||
        planityKey.trim() === ""
      ) {
        console.error(
          "❌ Planity key is not configured. Please define PLANITY_KEY in your .env file"
        );
        container.innerHTML =
          '<div style="text-align:center; padding:40px; background:white; border-radius:16px;"><h3 style="color:#dc3545;">Configuration error</h3><p>The booking widget is not configured correctly. Please contact the administrator.</p></div>';
        return;
      }

      // Widget configuration
      window.planity = {
        key: planityKey,
        primaryColor: "#000000",
        container,
      };

      // External Planity scripts
      const polyfills = document.createElement("script");
      polyfills.src =
        "https://d2skjte8udjqxw.cloudfront.net/widget/production/2/polyfills.latest.js";
      polyfills.async = true;
      document.body.appendChild(polyfills);

      const app = document.createElement("script");
      app.src =
        "https://d2skjte8udjqxw.cloudfront.net/widget/production/2/app.latest.js";
      app.async = true;
      document.body.appendChild(app);
    });
  </script>

  <!-- Fallback if widget fails to load -->
  <noscript>
    <div
      style="text-align:center; padding:40px; background:white; border-radius:16px; margin:40px 0;"
    >
      <h3>Le système de réservation nécessite JavaScript</h3>
      <p>
        Veuillez activer JavaScript pour utiliser le widget de réservation ou
        cliquez <a
          href="https://neatparis.fr/prise-de-rdv-1/"
          target="_blank"
          style="color:#4a5d4a;font-weight:bold;">here</a
        >
      </p>
    </div>
  </noscript>
</Layout>

<style>
  .main-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    background: rgba(42, 52, 42, 0);
    backdrop-filter: blur(0px);
    transition: all 0.3s ease;
  }
  .main-header.scrolled {
    background: rgba(42, 52, 42, 0.98);
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
  }
  .booking-section {
    position: relative;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding-top: 80px;
    padding-bottom: 40px;
  }
  .bg-hero-pattern {
    background-image: url("https://res.cloudinary.com/drhqmgbm0/image/upload/v1755728033/3_mbs6k1.jpg");
    background-position: center;
    background-size: cover;
    background-repeat: no-repeat;
  }
  .planity-wrapper {
    background-color: rgba(255, 255, 255, 0.95);
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    margin: 40px 0;
    max-width: 100%;
  }
</style>

<script>
  // Header sticky with scroll effect management
  (function () {
    const header = document.querySelector(".main-header");
    function checkScroll() {
      const scrollTop =
        window.pageYOffset || document.documentElement.scrollTop;
      if (scrollTop > 50) header?.classList.add("scrolled");
      else header?.classList.remove("scrolled");
    }
    checkScroll();
    window.addEventListener("scroll", checkScroll, { passive: true });
  })();
</script>
