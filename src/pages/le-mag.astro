---
import Layout from "../layouts/Layout.astro";
import BlogNavbar from "../components/Le Mag/BlogNavbar.astro";
import Footer from "../components/Footer.astro";
import BlogHeader from "../components/Le Mag/BlogHeader.astro";
import BlogCard from "../components/Le Mag/BlogCard.astro";
import { fetchGraphQL, GET_LATEST_POSTS } from "../lib/graphql";
import type { Post } from "../types/wordpress";
import { formatDateToFrench, stripHtml, truncateText } from "../lib/utils/date";

// Fetch posts from WordPress
let posts: Post[] = [];
let totalPosts = 0;
let totalPages = 0;
const postsPerPage = 6;

try {
  const data = await fetchGraphQL<{ posts: { nodes: Post[] } }>(
    GET_LATEST_POSTS,
    { first: 100 }
  );
  const allPosts = data.posts.nodes;
  totalPosts = allPosts.length;
  totalPages = Math.ceil(totalPosts / postsPerPage);

  // Get first page posts
  posts = allPosts.slice(0, postsPerPage);
} catch (error) {
  console.error("Error fetching posts:", error);
  posts = [];
}

const currentPage = 1;
const hasNextPage = totalPages > 1;
---

<Layout title="Le Mag - NEAT Barber Paris">
  <!-- Navbar for blog pages -->
  <BlogNavbar />

  <!-- Blog Header Section -->
  <BlogHeader title="LE MAG" subtitle="DÃ©couvrez nos articles et conseils" />

  <!-- Blog Posts Section -->
  <section class="blog-posts">
    <div class="container">
      <div class="row">
        {
          posts.map((post) => (
            <div class="col-lg-4 col-md-6 mb-4">
              <BlogCard
                title={post.title}
                excerpt={truncateText(stripHtml(post.excerpt), 150)}
                featuredImage={post.featuredImage?.node.sourceUrl}
                slug={post.slug}
                date={formatDateToFrench(post.date)}
              />
            </div>
          ))
        }
      </div>

      <!-- Pagination -->
      <div class="row mt-5">
        <div class="col-12">
          <nav aria-label="Pagination du blog">
            <ul class="pagination justify-content-center">
              <li class="page-item active">
                <a class="page-link" href="/le-mag">1</a>
              </li>
              {
                Array.from({ length: totalPages - 1 }, (_, i) => i + 2).map(
                  (pageNum) => (
                    <li class="page-item">
                      <a class="page-link" href={`/le-mag/page/${pageNum}`}>
                        {pageNum}
                      </a>
                    </li>
                  )
                )
              }
              {
                hasNextPage && (
                  <li class="page-item">
                    <a class="page-link" href="/le-mag/page/2">
                      Suivant
                    </a>
                  </li>
                )
              }
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </section>

  <Footer />
</Layout>

<style>
  /* Styles for blog section */
  .blog-posts {
    padding: 80px 0;
    background-color: #f8f9fa;
  }

  /* Styles for pagination */
  .pagination {
    gap: 5px;
  }

  .page-item .page-link {
    color: #4a5d4a;
    border: 1px solid #4a5d4a;
    border-radius: 5px;
    padding: 8px 16px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .page-item.active .page-link {
    background-color: #4a5d4a;
    border-color: #4a5d4a;
    color: #ffffff;
  }

  .page-item .page-link:hover {
    background-color: rgba(74, 93, 74, 0.1);
  }

  .page-item.active .page-link:hover {
    background-color: #4a5d4a;
  }

  /* Responsive */
  @media (max-width: 991px) {
    .blog-posts {
      padding: 60px 0;
    }
  }

  @media (max-width: 767px) {
    .blog-posts {
      padding: 50px 0;
    }
  }

  @media (max-width: 575px) {
    .blog-posts {
      padding: 40px 0;
    }
  }
</style>
