---
import Layout from "../../../layouts/Layout.astro";
import BlogNavbar from "../../../components/Le Mag/BlogNavbar.astro";
import Footer from "../../../components/Footer.astro";
import BlogHeader from "../../../components/Le Mag/BlogHeader.astro";
import BlogCard from "../../../components/Le Mag/BlogCard.astro";
import { fetchGraphQL, GET_LATEST_POSTS } from "../../../lib/graphql";
import type { Post } from "../../../types/wordpress";
import {
  formatDateToFrench,
  stripHtml,
  truncateText,
} from "../../../lib/utils/date";

// Function to generate static pages
export async function getStaticPaths() {
  try {
    // Fetch all posts from WordPress
    const data = await fetchGraphQL<{ posts: { nodes: Post[] } }>(
      GET_LATEST_POSTS,
      { first: 100 }
    );
    const allPosts = data.posts.nodes;
    const postsPerPage = 6;
    const totalPages = Math.ceil(allPosts.length / postsPerPage);

    // Generate a path for each page
    return Array.from({ length: totalPages }, (_, i) => {
      const pageNum = i + 1;
      const start = i * postsPerPage;
      const end = start + postsPerPage;
      const pagePosts = allPosts.slice(start, end);

      return {
        params: { page: pageNum.toString() },
        props: {
          posts: pagePosts,
          currentPage: pageNum,
          totalPages,
          hasNextPage: pageNum < totalPages,
          hasPrevPage: pageNum > 1,
        },
      };
    });
  } catch (error) {
    console.error("Error in getStaticPaths:", error);
    return [];
  }
}

// Get props from getStaticPaths
const { posts, currentPage, totalPages, hasNextPage, hasPrevPage } =
  Astro.props as {
    posts: Post[];
    currentPage: number;
    totalPages: number;
    hasNextPage: boolean;
    hasPrevPage: boolean;
  };
---

<Layout title={`Le Mag - Page ${currentPage} - NEAT Barber Paris`}>
  <!-- Blog pages navbar -->
  <BlogNavbar />

  <!-- Blog Header Section -->
  <BlogHeader title="LE MAG" subtitle="Découvrez nos articles et conseils" />

  <!-- Blog Posts Section -->
  <section class="blog-posts">
    <div class="container">
      <div class="row">
        {
          posts.map((post) => (
            <div class="col-lg-4 col-md-6 mb-4">
              <BlogCard
                title={post.title}
                excerpt={truncateText(stripHtml(post.excerpt), 150)}
                featuredImage={post.featuredImage?.node.sourceUrl}
                slug={post.slug}
                date={formatDateToFrench(post.date)}
              />
            </div>
          ))
        }
      </div>

      <!-- Pagination -->
      <div class="row mt-5">
        <div class="col-12">
          <nav aria-label="Pagination du blog">
            <ul class="pagination justify-content-center">
              {
                hasPrevPage && (
                  <li class="page-item">
                    <a
                      class="page-link"
                      href={
                        currentPage === 2
                          ? "/le-mag"
                          : `/le-mag/page/${currentPage - 1}`
                      }
                    >
                      Précédent
                    </a>
                  </li>
                )
              }

              <li class="page-item">
                <a class="page-link" href="/le-mag">1</a>
              </li>

              {
                Array.from({ length: totalPages - 1 }, (_, i) => i + 2).map(
                  (pageNum) => (
                    <li
                      class={`page-item ${pageNum === currentPage ? "active" : ""}`}
                    >
                      <a class="page-link" href={`/le-mag/page/${pageNum}`}>
                        {pageNum}
                      </a>
                    </li>
                  )
                )
              }

              {
                hasNextPage && (
                  <li class="page-item">
                    <a
                      class="page-link"
                      href={`/le-mag/page/${currentPage + 1}`}
                    >
                      Suivant
                    </a>
                  </li>
                )
              }
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </section>

  <Footer />
</Layout>

<style>
  .blog-posts {
    padding: 80px 0;
    background-color: #f8f9fa;
  }

  .pagination {
    gap: 5px;
  }

  .page-item .page-link {
    color: #4a5d4a;
    border: 1px solid #4a5d4a;
    border-radius: 5px;
    padding: 8px 16px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .page-item.active .page-link {
    background-color: #4a5d4a;
    border-color: #4a5d4a;
    color: #ffffff;
  }

  .page-item .page-link:hover {
    background-color: rgba(74, 93, 74, 0.1);
  }

  .page-item.active .page-link:hover {
    background-color: #4a5d4a;
  }

  /* Responsive */
  @media (max-width: 991px) {
    .blog-posts {
      padding: 60px 0;
    }
  }

  @media (max-width: 767px) {
    .blog-posts {
      padding: 50px 0;
    }
  }

  @media (max-width: 575px) {
    .blog-posts {
      padding: 40px 0;
    }
  }
</style>
